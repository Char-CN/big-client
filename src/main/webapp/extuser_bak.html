<script>
    $(function () {
        var lock = false;
        // 定义分页控件
        var pagination = new PageHelper("pagination");
        var _currentPage_lastCurrent = 1;
        var findByPage = function (currentPage) {
            if (lock) {
                return;
            }
            _currentPage_lastCurrent = currentPage;
            lock = true;
            $.post("user/findUserByPage.do", {
                currentPage: currentPage,
                pageSize: 10,
                userIdentify: "DKH000",
                search: search_text
            }, function (data) {
                // alert(JSON.stringify(data.page));
                init(data.list);
                // 初始化分页控件：参数：(当前页，页大小，总条数，点击分页时候调用的方法)
                pagination.init(data.pageNum, data.pageSize, data.total, findByPage);
                lock = false;
            });
        };

        //刷新当前页
        var reload = function() {
            findByPage(_currentPage_lastCurrent);
        };

        // 初始化数据
        var init = function (rst) {
            $("#tb>tbody").empty();
            for (var i in rst) {
                var cls = i % 2 == 0 ? "info" : "warning";
                var tr = $('<tr class="' + cls + '">');
                /**
                 * <field name="id" title="自动编号"/>
                 <field name="excelId" title="excel关联id"/>
                 <field name="phoneNumber" title="手机号码"/>
                 <field name="userName" title="客户姓名"/>
                 <field name="sex" title="性别"/>
                 <field name="age" title="年龄"/>
                 <field name="birthday" title="出生日期"/>
                 <field name="idCard" title="证件号码"/>
                 <field name="assetsAmount" title="资产总额"/>
                 <field name="ifEmployee" title="是否员工"/>
                 <field name="ifRegister" title="是否注册"/>
                 <field name="registerDate" title="注册日期"/>
                 <field name="ifRealName" title="是否实名"/>
                 <field name="ifBindCard" title="是否绑卡"/>
                 <field name="ifTransaction" title="是否有过交易"/>
                 <field name="referrer" title="扫码推荐人"/>
                 <field name="referrerPhoneNumber" title="推荐人手机号"/>
                 <field name="ifReferrerEmployee" title="推荐人是否员工"/>
                 <field name="rebateExpirationDate" title="返利失效日期"/>
                 <field name="reportOrAllot" title="上报/分配"/>
                 <field name="reportOrAllotDate" title="上报/分配时间"/>
                 <field name="userIdentify" title="客户标识"/>
                 <field name="investmentAdviser" title="投资顾问"/>
                 <field name="ifDelete" title="是否删除"/>
                 <field name="mtime" title="更新时间" pattern="yyyy-MM-dd"/>
                 <field name="ctime" title="创建时间" pattern="yyyy-MM-dd"/>*/
                tr.append('<td>' + rst[i].phoneNumber + '</td>');
                tr.append('<td>' + rst[i].investmentAdviser + '</td>');

				var td = $("<td>");
				td.append($("<a class='compileA'>编辑</a>").click({
					id : rst[i].id,
                    phoneNumber: rst[i].phoneNumber,
                    sysName: rst[i].sysName,
                    sysIfRegister: rst[i].sysIfRegister,
                    sysRegisterDate: rst[i].sysRegisterDate,
                    sysIfRealName: rst[i].sysIfRealName,
                    sysIfBindCard: rst[i].sysIfBindCard,
                    sysIfTransaction: rst[i].sysIfTransaction,
                    sysReferrer: rst[i].sysReferrer,
                    sysRebateExpirationDate: rst[i].sysRebateExpirationDate
				}, function(event) {
                    $util.modal("修改用户", "extuser_add_edit.html", {
                        id : event.data.id,
                        phoneNumber: event.data.phoneNumber,
                        sysName: event.data.sysName,
                        sysIfRegister: event.data.sysIfRegister,
                        sysRegisterDate: event.data.sysRegisterDate,
                        sysIfRealName: event.data.sysIfRealName,
                        sysIfBindCard: event.data.sysIfBindCard,
                        sysIfTransaction: event.data.sysIfTransaction,
                        sysReferrer: event.data.sysReferrer,
                        sysRebateExpirationDate: event.data.sysRebateExpirationDate
                    }, function() {
                        //刷新当前页
                        reload();
                    });
				}));
				td.append($("<a class='removeA'>删除</a>").click({
					id : rst[i].id
				}, function(event) {
				    var id = event.data.id;
                    var r = confirm("确定要删除该用户吗？删除后数据无法恢复！！！")
                    if (r == true) {
                        console.log(id);
                        $.post("ext/deleteById.do", {id: id}, function (data) {
                            alert(data.msg);
                            //刷新当前页
                            reload();
                        });
                    }
				}));

				tr.append(td);
				$("#tb>tbody").append(tr);
			}
		};

		findByPage(1);
		$("#search").click(function() {
			findByPage(1);
		});
		var search_text = "";
		$("#search_text").change(function() {
			search_text = $(this).val();
		});


		/**ajax上传excel*/
		$('#importExcel').click(function() {
			$("#fileExcel").click();
		});

		/**选择上传文件后触发*/
		$('#fileExcel').change(function() {
			var r = confirm("确定要上传该Excel文件吗？")
			if (r == true) {
				ajaxFileUpload();
			} else {
				$("#fileExcel").val("");
			}
		});

		//ajax上传文件
		var ajaxFileUpload = function() {
			$.ajaxFileUpload({
				url : "/ext/upload.do", //用于文件上传的服务器端请求地址
				type : "post",
				secureuri : false, //一般设置为false
				fileElementId : "fileExcel", //文件上传空间的id属性
				dataType : "json", //返回值类型 一般设置为json
				success : function(data, status) { //服务器成功响应处理函数
					console.log(data);
					/** 0:失败,1:成功,2:未登录或session过期,3:无权限 */
					if (data.code == 0) {
						alert(data.msg);
					} else if (data.code == 1) {
						var excelName = data.obj.excelName;
						alert(excelName + " ,该文件已成功上传，" + data.msg);
					} else {
						alert(data.msg);
					}
				},
				error : function(data, status, e) { //服务器响应失败处理函数
					alert(data.msg + "---" + e);
				}
			});
		};

		/**
		 * ajax下载excel
		 */
		$("#exportExcel").click(function() {
			downLoadFile({
				url : '/ext/export/excel.do', //请求的url
				data : {search : search_text},//要发送的数据
				callback : function() {
					//alert("导出excel文件成功");
				}
			});
		});

        /**
         * 保存用户
         */
        $('#addOneUser').click(function() {
			$util.modal("新增人员", "extuser_add_edit.html", {}, function() {
				reload();
			});
		});


    });
</script>
<div class="row" style="margin: 0;">
    <div class="input-group has-primary" style="float: left; width: 200px;">
        <input id="search_text" type="text" class="form-control" placeholder="Search for..."/> <span
            class="input-group-btn">
			<button id="search" class="btn btn-primary" type="button">搜索</button>
		</span>
    </div>
    <button type="button" id="exportExcel" class="btn btn-primary" style="float: right;">导出Excel</button>
    <button type="button" id="importExcel" class="btn btn-primary" style="float: right; margin-right: 10px;">导入Excel</button>
    <button type="button" id="addOneUser" class="btn btn-primary" style="float: right; margin-right: 10px;">新增用户</button>
    <input type="file" id="fileExcel" name="fileExcel" accept=".xls,.xlsx" style="display: none"/>
</div>
<hr class="line-3"/>
<!-- /.col-lg-6 -->
<table id="tb" class="table table-hover table-condensed table-bordered">
    <thead>
    <tr>
        <th width="10%">手机号码</th>
        <th width="10%">投资顾问</th>
        <th width="10%">操作</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<ul id="pagination" class="pagination" style="cursor:pointer"></ul>
<!--
	<ul id="pagination" class="pagination" style="cursor:pointer">
		<li><a href="#" aria-label="Previous"> <span aria-hidden="true">首页</span>
		</a></li>
		<li><a href="#" aria-label="Previous"> <span aria-hidden="true">上一页</span>
		</a></li>
		<li class="active"><a href="#">1</a></li>
		<li><a href="#">2</a></li>
		<li><a href="#">3</a></li>
		<li><a href="#">4</a></li>
		<li><a href="#">5</a></li>
		<li><a href="#" aria-label="Next"> <span aria-hidden="true">下一页</span>
		</a></li>
		<li><a href="#" aria-label="Previous"> <span aria-hidden="true">尾页</span>
		</a></li>
		<li><span aria-hidden="true">
		每页
			<select>
				<option>10</option>
				<option>20</option>
				<option>50</option>
				<option>100</option>
			</select>
-->              